{% extends "base.html" %}
{% block title %}Logs - Admin{% endblock %}

{% block nav %}
<nav class="container nav">
    <a href="/admin/submissions" class="logo">Admin</a>
    <div class="nav-links">
        <a href="/admin/submissions">Submissions</a>
        <a href="/admin/logs">Logs</a>
        <span style="color:#555;font-size:0.8rem;font-family:monospace;">{{ client_ip }}</span>
        <a href="/admin/logout">Logout</a>
    </div>
</nav>
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 style="font-size:1.6rem;font-weight:400;color:#fff;margin-bottom:24px;">Request Logs</h1>

        <div style="display:flex;gap:32px;align-items:flex-start;">
            <div style="min-width:160px;">
                <h3 style="font-size:0.8rem;color:#666;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px;">Dates</h3>
                {% for d in dates %}
                <a href="/admin/logs/{{ d }}" style="display:block;padding:6px 0;font-size:0.85rem;{% if d == selected_date %}color:#2563eb;font-weight:500;{% else %}color:#888;{% endif %}">{{ d }}</a>
                {% endfor %}
                {% if not dates %}
                <p style="color:#666;font-size:0.85rem;">No logs yet.</p>
                {% endif %}
            </div>

            {% if entries is not none %}
            <div style="flex:1;min-width:0;">
                <div style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
                    <a href="/admin/logs/{{ selected_date }}{% if status_filter %}?status={{ status_filter }}{% endif %}" class="btn {% if not event_filter %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:6px 12px;font-size:0.8rem;">All</a>
                    <a href="/admin/logs/{{ selected_date }}?event=request{% if status_filter %}&status={{ status_filter }}{% endif %}" class="btn {% if event_filter == 'request' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:6px 12px;font-size:0.8rem;">Requests</a>
                    <a href="/admin/logs/{{ selected_date }}?event=session_start{% if status_filter %}&status={{ status_filter }}{% endif %}" class="btn {% if event_filter == 'session_start' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:6px 12px;font-size:0.8rem;">Sessions</a>
                    <a href="/admin/logs/{{ selected_date }}?event=form_submission{% if status_filter %}&status={{ status_filter }}{% endif %}" class="btn {% if event_filter == 'form_submission' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:6px 12px;font-size:0.8rem;">Forms</a>
                    <a href="/admin/logs/{{ selected_date }}?event=beacon{% if status_filter %}&status={{ status_filter }}{% endif %}" class="btn {% if event_filter == 'beacon' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:6px 12px;font-size:0.8rem;">Beacons</a>
                </div>
                <div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                    <span style="color:#666;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;">Status:</span>
                    <a href="/admin/logs/{{ selected_date }}{% if event_filter %}?event={{ event_filter }}{% endif %}" class="btn {% if not status_filter %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:4px 10px;font-size:0.75rem;">All</a>
                    <a href="/admin/logs/{{ selected_date }}?status=2xx{% if event_filter %}&event={{ event_filter }}{% endif %}" class="btn {% if status_filter == '2xx' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:4px 10px;font-size:0.75rem;">2xx</a>
                    <a href="/admin/logs/{{ selected_date }}?status=3xx{% if event_filter %}&event={{ event_filter }}{% endif %}" class="btn {% if status_filter == '3xx' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:4px 10px;font-size:0.75rem;">3xx</a>
                    <a href="/admin/logs/{{ selected_date }}?status=4xx{% if event_filter %}&event={{ event_filter }}{% endif %}" class="btn {% if status_filter == '4xx' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:4px 10px;font-size:0.75rem;">4xx</a>
                    <a href="/admin/logs/{{ selected_date }}?status=5xx{% if event_filter %}&event={{ event_filter }}{% endif %}" class="btn {% if status_filter == '5xx' %}btn-primary{% else %}btn-secondary{% endif %}" style="padding:4px 10px;font-size:0.75rem;">5xx</a>
                </div>

                <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px;flex-wrap:wrap;">
                    <p style="color:#666;font-size:0.8rem;margin:0;" id="entryCount">{{ total }} entries</p>
                    <label style="color:#666;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;gap:6px;">
                        <input type="checkbox" id="hideMyIp" style="cursor:pointer;"> Hide my IP <span style="font-family:monospace;">({{ client_ip }})</span>
                    </label>
                    <label style="color:#666;font-size:0.8rem;display:flex;align-items:center;gap:6px;">
                        Per page
                        <select id="perPage" style="background:#111;color:#aaa;border:1px solid #333;border-radius:4px;padding:3px 6px;font-size:0.8rem;cursor:pointer;">
                            {% for n in [25, 50, 100, 250] %}
                            <option value="{{ n }}" {% if n == per_page %}selected{% endif %}>{{ n }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>

                {% if entries %}
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:1px solid #333;text-align:left;">
                                {% for col, field in [('Time', 'ts'), ('Event', 'event'), ('Status', 'status'), ('IP', 'ip')] %}
                                <th style="padding:8px 10px;color:#888;font-size:0.75rem;font-weight:500;cursor:pointer;user-select:none;white-space:nowrap;" onclick="sortBy('{{ field }}')">
                                    {{ col }}{% if sort == field %} {{ '▲' if order == 'asc' else '▼' }}{% endif %}
                                </th>
                                {% endfor %}
                                <th style="padding:8px 10px;color:#888;font-size:0.75rem;font-weight:500;">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in entries %}
                            <tr data-ip="{{ e.ip | default('') }}" style="border-bottom:1px solid #1a1a1a;cursor:pointer;" onclick="var d=this.nextElementSibling;d.style.display=d.style.display==='none'?'table-row':'none'">
                                <td style="padding:8px 10px;font-size:0.8rem;color:#aaa;white-space:nowrap;font-family:monospace;">{{ e.iso[11:19] if e.iso else '' }}</td>
                                <td style="padding:8px 10px;font-size:0.8rem;"><span style="background:#1a1a1a;border:1px solid #333;border-radius:4px;padding:2px 8px;font-size:0.75rem;color:#60a5fa;">{{ e.event }}</span></td>
                                <td style="padding:8px 10px;font-size:0.8rem;font-family:monospace;">{% if e.status %}<span style="{% if e.status >= 500 %}color:#ef4444;{% elif e.status >= 400 %}color:#f59e0b;{% elif e.status >= 300 %}color:#8b5cf6;{% else %}color:#22c55e;{% endif %}">{{ e.status }}</span>{% else %}<span style="color:#444;">—</span>{% endif %}</td>
                                <td style="padding:8px 10px;font-size:0.8rem;color:#666;font-family:monospace;">{{ e.ip | default('') }}</td>
                                <td style="padding:8px 10px;font-size:0.8rem;color:#aaa;">
                                    {% if e.event == 'request' %}
                                        <span style="color:#e0e0e0;">{{ e.method }} {{ e.path }}</span> <span style="color:#666;">{{ e.duration_ms }}ms</span>
                                    {% elif e.event == 'form_submission' %}
                                        <span style="color:#e0e0e0;">{{ e.form }}</span> <span style="color:#666;">&middot; {{ e.fields.full_name or e.fields.contact_name or '' }}</span>
                                    {% elif e.event == 'session_start' %}
                                        <span style="color:#666;">sid: {{ e.sid[:12] }}...</span>
                                    {% elif e.event == 'beacon' %}
                                        <span style="color:#666;">{{ e.payload.t | default('') }}</span>
                                    {% else %}
                                        <span style="color:#666;">{{ e | tojson | truncate(80) }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr style="display:none;">
                                <td colspan="5" style="padding:0 10px 12px;"><pre style="background:#111;border:1px solid #222;border-radius:6px;padding:16px;overflow-x:auto;font-size:0.8rem;color:#aaa;line-height:1.5;margin:4px 0 0;">{{ e | tojson(indent=2) }}</pre></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if total_pages > 1 %}
                <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:16px;">
                    {% if page > 1 %}
                    <a href="{{ paginate_url(page - 1) }}" class="btn btn-secondary" style="padding:6px 12px;font-size:0.8rem;">← Prev</a>
                    {% endif %}
                    <span style="color:#666;font-size:0.8rem;">Page {{ page }} of {{ total_pages }}</span>
                    {% if page < total_pages %}
                    <a href="{{ paginate_url(page + 1) }}" class="btn btn-secondary" style="padding:6px 12px;font-size:0.8rem;">Next →</a>
                    {% endif %}
                </div>
                {% endif %}

                {% else %}
                <p style="color:#666;font-size:0.85rem;">No entries match the filter.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block footer %}{% endblock %}
{% block scripts %}
<script>
(function(){
    var cb=document.getElementById('hideMyIp');
    if(cb){
        var myIp='{{ client_ip }}';
        cb.addEventListener('change',function(){
            var rows=document.querySelectorAll('tr[data-ip]');
            var visible=0;
            rows.forEach(function(r){
                var hide=cb.checked&&r.getAttribute('data-ip')===myIp;
                r.style.display=hide?'none':'';
                r.nextElementSibling.style.display='none';
                if(!hide)visible++;
            });
            document.getElementById('entryCount').textContent=visible+' of {{ total }} entries';
        });
    }
    var pp=document.getElementById('perPage');
    if(pp){
        pp.addEventListener('change',function(){
            var params=new URLSearchParams(window.location.search);
            params.set('per_page',pp.value);
            params.set('page','1');
            window.location.search=params.toString();
        });
    }
})();
function sortBy(field){
    var params=new URLSearchParams(window.location.search);
    var cur=params.get('sort')||'ts';
    var ord=params.get('order')||'desc';
    if(cur===field){ord=ord==='desc'?'asc':'desc';}
    else{ord='desc';}
    params.set('sort',field);
    params.set('order',ord);
    params.set('page','1');
    window.location.search=params.toString();
}
</script>
{% endblock %}
